# å‰è¨€

åœ¨ä¸Šç¯‡æ–‡ç« ä¸­ï¼Œä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦å±•å¼€äº†å¯¹ç±»åŠ è½½å™¨å…¨é¢çš„ä»‹ç»ï¼Œ**ç±»åŠ è½½å™¨åˆå§‹åŒ–çš„æ—¶æœºã€ç±»åŠ è½½å™¨åŠ è½½ç±»çš„æ–¹å¼ã€ä»‹ç»å„ç§äº”èŠ±å…«é—¨çš„ç±»åŠ è½½å™¨ã€å„ç§ç±»åŠ è½½å™¨åŠ è½½æ–‡ä»¶çš„è·¯å¾„ã€ç±»åŠ è½½å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹**ï¼Œçœ‹åˆ°è¿™çš„å°ä¼™ä¼´åº”è¯¥å¯¹ç±»åŠ è½½å™¨æœ‰ä¸€ä¸ªå¤§ä½“çš„äº†è§£ï¼Œé‚£ä¹ˆæˆ‘åœ¨è¿™é—®ä¸¤ä¸ªé—®é¢˜ï¼š

1. ä¸ºä»€ä¹ˆ**ä¸åŒçš„ç±»åŠ è½½å™¨çš„è¯»å–ç±»è·¯å¾„ä¸åŒ**
2. æ¯ä¸ªç±»åŠ è½½å™¨çš„parentå±æ€§åˆ°åº•æœ‰ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦**è®¾ç«‹è¿™ç§çˆ¶å­å…³ç³»**

å…¶å®è¿™äº›é—®é¢˜çš„è§£é‡Šéƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªæœºåˆ¶æ¥å›ç­”ï¼šå°±æ˜¯**åŒäº²å§”æ´¾æœºåˆ¶**ï¼Œå®ƒæ˜¯ç±»åŠ è½½å™¨åŠ è½½ç±»çš„ä¸€ä¸ª**ç‰¹ç‚¹**ï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯ç”±**Javaå±‚é¢çš„ä»£ç å®ç°çš„**ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°±ä¸“é—¨**ç›˜ç›˜**è¿™ä¸ªæœºåˆ¶

# åŒäº²å§”æ´¾æœºåˆ¶

## åŒäº²å§”æ´¾æœºåˆ¶æµç¨‹å›¾

åŒäº²å§”æ´¾æœºåˆ¶æ€»ç»“èµ·æ¥å°±æ˜¯ä¸€å¥è¯ï¼š**çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥å°±æœ‰å­ç±»åŠ è½½å™¨è‡ªå·±åŠ è½½**ï¼Œä½†æ˜¯è¿™å¥è¯è‚¯å®šå¾ˆå¤šå°ä¼™ä¼´çœ‹åˆ°éƒ½ä¼šä¸€è„¸æ‡µé€¼ï¼Œæ‰€ä»¥ç”»ä¸ª**æµç¨‹å›¾**æ¥è®²ä¸‹åŒäº²å§”æ´¾æœºåˆ¶çš„æµç¨‹ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2bf8867072d409cb332dc619b6bf5eb~tplv-k3u1fbpfcp-watermark.image)

ä»æµç¨‹å›¾ä¸Šæ¥çœ‹`åº”ç”¨ç±»åŠ è½½å™¨`åŠ è½½ç±»é¦–å…ˆä¼šå§”æ‰˜ç»™`æ‰©å±•ç±»åŠ è½½å™¨`ï¼Œå½“æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ç±»çš„æ—¶å€™ä¼šå§”æ‰˜ç»™`å¼•å¯¼ç±»åŠ è½½å™¨`(å…ˆä¸è€ƒè™‘è‡ªå®šä¹‰ç±»åŠ è½½å™¨)

å½“`å¼•å¯¼ç±»åŠ è½½å™¨`åŠ è½½å¤±è´¥çš„æ—¶å€™ä¼šäº¤ç»™å­ç±»`æ‰©å±•ç±»åŠ è½½å™¨`å†æ­¤å°è¯•åŠ è½½ï¼Œå½“æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½å¤±è´¥çš„æ—¶å€™ä¼šäº¤ç»™å­ç±»`åº”ç”¨ç±»åŠ è½½å™¨`è¿›è¡ŒåŠ è½½

ä»æ•´ä½“ä¸Šæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ª`è‡ªä¸‹è€Œä¸Šå†è€Œä¸‹`çš„è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹

## åŒäº²å§”æ´¾æœºåˆ¶æºç åˆ†æ

è¿™ä¹ˆ**å¹²å·´å·´**çš„è¯´ï¼Œç›¸ä¿¡è¿˜æœ‰ä¸å°‘çš„å°ä¼™ä¼´ä¼šæ‡µé€¼ï¼Œæ‰€ä»¥å†ç»“åˆæºç æ¥çœ‹çœ‹è¿™ä¸ª**åŒäº²å§”æ´¾æœºåˆ¶**ï¼Œæˆ‘ä»¬ä»¥TestJDKClassLoaderç±»ä¸ºä¾‹ï¼š

```java
public class TestJDKClassLoader {
    public static void main(String[] args) {
        system.out.println("ç±»åŠ è½½.......");
    }
}
```

é¦–å…ˆï¼Œæ ¹æ®**ä¸Šç¯‡æ–‡ç« å¯çŸ¥**ï¼Œä¸‹å›¾ä¸­çš„å‡ºç°çš„**loaderå°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–Launcherçš„æ—¶å€™èµ‹å€¼çš„AppClassLoader**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b01ca0ac3d664a03ab0a6bdea2085bbd~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘ä»¬åœ¨å¹³å¸¸è°ƒç”¨ç±»åŠ è½½å™¨åŠ è½½ç±»çš„æ—¶å€™é€šå¸¸è°ƒç”¨çš„æ˜¯ClassLoaderé‡Œé¢çš„loadClassæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä»`sun.misc.Launcher.AppClassLoader#loadClass`ä½œä¸ºå…¥å£ï¼Œå¥½å¥½çœ‹çœ‹å…·ä½“çš„å®ç°

```
        public Class<?> loadClass(String var1, boolean var2) throws ClassNotFoundException {
            // æ— å…³ä»£ç ï¼Œå…ˆä¸å…³æ³¨
            ......
            if (this.ucp.knownToNotExist(var1)) {
                // æ— å…³ä»£ç ï¼Œå…ˆä¸å…³æ³¨
                ......
                } else {
                    throw new ClassNotFoundException(var1);
                }
            } else {
                // æœ€åè°ƒç”¨äº†çˆ¶ç±»çš„loadClassæ–¹æ³•
                return super.loadClass(var1, var2);
            }
        }
```

`çˆ¶ç±»çš„loadClassæ–¹æ³•`

```
// classLoaderçš„loadClassæ–¹æ³•ï¼Œé‡Œé¢å®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶
protected Class<?> loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
        synchronized (getClassLoadingLock(name)) {
            // æ£€æŸ¥å½“å‰ç±»åŠ è½½å™¨æ˜¯å¦å·²ç»åŠ è½½äº†è¯¥ç±»
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                long t0 = System.nanoTime();
                try {
                    // å¦‚æœå½“å‰åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºåˆ™å§”æ‰˜çˆ¶ç±»ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
                    if (parent != null) {
                        c = parent.loadClass(name, false);
                    } else {
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {
                    // ClassNotFoundException thrown if class not found
                    // from the non-null parent class loader
                }

                if (c == null) {
                    // If still not found, then invoke findClass in order
                    // to find the class.
                    long t1 = System.nanoTime();
                    // éƒ½ä¼šè°ƒç”¨URLClassLoaderçš„findClassæ–¹æ³•åœ¨åŠ è½½å™¨çš„ç±»è·¯å¾„é‡ŒæŸ¥æ‰¾å¹¶åŠ è½½è¯¥ç±»
                    c = findClass(name);
                    // this is the defining class loader; record the stats
                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    sun.misc.PerfCounter.getFindClasses().increment();
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }
```

åŒäº²å§”æ´¾æ¨¡å¼å°±æ˜¯åœ¨è¿™ä¸ªloadClassæ–¹æ³•ä¸­å®ç°çš„ï¼Œæˆ‘ä»¬å°±ä¸€æ­¥æ­¥æŠ½ä¸å‰¥èŒ§çš„æ¥çœ‹è¿™ä¸ªæ–¹æ³•

é¦–å…ˆè°ƒç”¨**æœ¬åœ°æ–¹æ³•findLoadedClass**ï¼Œå¦‚æœå·²ç»åŠ è½½å°±è¿”å›è¯¥ç±»ï¼Œå¦‚æœæ²¡æœ‰è¿”å›è¿”å›nullï¼Œç´§æ¥ç€å°±åœ¨findLoadedClasså¤–éƒ¨åˆ¤æ–­ï¼Œå¦‚æœ**ä¸ä¸ºnullè¯´æ˜å·²ç»åŠ è½½è¿‡**ï¼Œå°±ç›´æ¥è¿”å›ï¼Œç¬¬ä¸€æ¬¡è¿›æ¥è‚¯å®šæ²¡æœ‰åŠ è½½è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œ**è¿”å›çš„ä¸€å®šæ˜¯null**

```
    protected final Class<?> findLoadedClass(String name) {
        if (!checkName(name))
            return null;
        return findLoadedClass0(name);
    }
    private native final Class<?> findLoadedClass0(String name);
```

è¿”å›æ˜¯nullï¼Œè¯´æ˜è¿™ä¸ªç±»æ²¡æœ‰è¢«åŠ è½½è¿‡ï¼Œé‚£ä¹ˆå°±åˆ¤æ–­**å½“å‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯å¦ä¸ºç©º**ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œå°±è®©çˆ¶åŠ è½½å™¨è¿›è¡ŒåŠ è½½

```
// å¦‚æœå½“å‰åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºåˆ™å§”æ‰˜çˆ¶ç±»ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
if (parent != null) {
   c = parent.loadClass(name, false);
}
```

**å½“å‰æ˜¯AppClassLoaderï¼Œçˆ¶åŠ è½½å™¨æ˜¯ExtClassLoaderï¼Œæ‰€ä»¥è¿™é‡Œè‚¯å®šä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClassæ–¹æ³•**ï¼Œ`ç›¸å½“äºæ˜¯AppClassLoaderå§”æ‰˜ç»™ExtClassLoaderè¿›è¡ŒåŠ è½½`

è¿›å…¥åˆ°çˆ¶ç±»åŠ è½½å™¨çš„**loadClassæ–¹æ³•**ä¹‹åï¼Œè¿˜æ˜¯ä¸€æ ·çš„**å¥—è·¯**ï¼Œä½†æ˜¯ExtClassLoaderçš„çˆ¶å±æ€§parentæ˜¯nullï¼Œæ‰€ä»¥è¿›å…¥åˆ°**findBootstrapClassOrNullæ–¹æ³•**ä¸­ï¼ŒfindBootstrapClassOrNullè¿™ä¸ªæ–¹æ³•å°±**ç›¸å½“äºå§”æ‰˜ç»™BootStrapLoaderç±»åŠ è½½å™¨**


```
    // å¦‚æœå½“å‰åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºåˆ™å§”æ‰˜çˆ¶ç±»ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½
    if (parent != null) {
       c = parent.loadClass(name, false);
    } else {
       c = findBootstrapClassOrNull(name);
    }
    // åˆ¤æ–­BootstrapClassLoaderæ˜¯å¦åŠ è½½äº†è¯¥ç±»ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½ï¼Œç›´æ¥è¿”å›null
    private Class<?> findBootstrapClassOrNull(String name)
    {
        if (!checkName(name)) return null;

        return findBootstrapClass(name);
    }
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›null
    private native Class<?> findBootstrapClass(String name);
```

`BootStrapLoaderç±»åŠ è½½å™¨`å¼€å§‹åŠ è½½ï¼Œå®ƒä¼šå»å¯¹åº”çš„åŠ è½½è·¯å¾„ä¸­å»å¯»æ‰¾ï¼Œä½†æ˜¯`TestJDKClassLoaderç±»`æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ï¼Œjdkçš„æ ¸å¿ƒåŒ…é‡Œå½“ç„¶æ²¡æœ‰ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå¤±è´¥ï¼Œè¿”å›nullä¹‹åï¼Œè¿˜æ˜¯åœ¨`ExtClassLoaderç±»çš„loadClassæ–¹æ³•ä¸­`ï¼Œ**ç›¸å½“äºExtClassLoaderç±»åŠ è½½å™¨æ¥å—äº†BootStrapLoaderå§”æ‰˜**ï¼Œç´§æ¥ç€è¿›å…¥åˆ°ä¸‹é¢çš„è¿™æ®µä»£ç ä¸­

```
                if (c == null) {
                    long t1 = System.nanoTime();
                    c = findClass(name);
                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    sun.misc.PerfCounter.getFindClasses().increment();
                }
```

ExtClassLoaderç±»åŠ è½½å™¨æ¥å—BootStrapLoaderå§”æ‰˜ï¼Œä»lib\extè·¯å¾„ä¸­å»å¯»æ‰¾**findClassæ–¹æ³•å°±æ˜¯å¯»æ‰¾çš„å®ç°**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a1d069c74a3142d7b9c61f7ac6c3abcc~tplv-k3u1fbpfcp-zoom-1.image)

æ•´ä¸ªfindClassæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ç”¨çº¢æ¡†æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œ**é¦–å…ˆå®ƒä¼šæ‹¼å‡ºç±»çš„è·¯å¾„ï¼ˆæŠŠ"."æ›¿æ¢æˆ"/"ï¼Œå†åç¼€åŠ ä¸Šclassï¼‰ï¼Œå†æ ¹æ®è¿™ä¸ªç±»è·¯å¾„ï¼Œä»å½“å‰ç±»åŠ è½½å™¨è´Ÿè´£çš„ç±»è·¯å¾„ä¸‹å¼€å§‹å¯»æ‰¾ï¼Œå¦‚æœå¯»æ‰¾åˆ°å°±æ‰§è¡ŒdefineClassæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å°±ç›´æ¥è¿”å›null**

æ˜¾è€Œæ˜“è§ï¼ŒExtClassLoaderä¸ä¼šåŠ è½½æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„`TestJDKClassLoaderç±»`ï¼Œæœ€åè¿”å›çš„è¿˜æ˜¯null

ä½†æ˜¯`c = parent.loadClass(name, false)`è¿™è¡Œä»£ç æ˜¯ä¸€ä¸ªåµŒå¥—æ–¹æ³•ï¼ŒExtClassLoaderæœ€åè¿”å›nullåï¼Œä¼šè¿”å›åˆ°AppClassLoaderç±»**ç›¸å½“äºæ˜¯AppClassLoaderç±»åŠ è½½å™¨æ¥å—äº†ExtClassLoaderå§”æ‰˜**ï¼Œæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç 

```
                if (c == null) {
                    long t1 = System.nanoTime();
                    c = findClass(name);
                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    sun.misc.PerfCounter.getFindClasses().increment();
                }
```

AppClassLoaderç±»åŠ è½½å™¨æ¥å—ExtClassLoaderå§”æ‰˜ï¼Œä»å¯¹åº”è·¯å¾„ä¸­å»å¯»æ‰¾**findClassæ–¹æ³•å°±æ˜¯å¯»æ‰¾çš„å®ç°**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a1d069c74a3142d7b9c61f7ac6c3abcc~tplv-k3u1fbpfcp-zoom-1.image)

æœ€åæ‰§è¡Œ`defineClassè¿™ä¸ªæ–¹æ³•`ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåšçš„äº‹æƒ…å°±æ˜¯**ç±»çš„åŠ è½½è¿‡ç¨‹**ï¼Œ**åŠ è½½->éªŒè¯->å‡†å¤‡->è§£æ->åˆå§‹åŒ–**è¿™äº”æ­¥ï¼Œ**æˆ‘ä»¬åœ¨è¿™é‡Œä¸ç»§ç»­è·Ÿè¿›å»äº†ï¼ˆå¦‚æœè·Ÿè¿›å»è¦ç¿»HotSpot æºç äº†ï¼Œè¿™ä¸€ç« ä¸­æˆ‘ä»¬å…ˆè®²åŒäº²å§”æ´¾æœºåˆ¶ï¼‰**


**è‡³æ­¤ï¼Œå°±æ˜¯æˆ‘ä»¬å®Œæˆçš„ä¸€ä¸ªåŒäº²å§”æ´¾æœºåˆ¶çš„æµç¨‹ï¼Œä»AppClassLoaderå¼€å§‹å§”æ‰˜ç»™ExtClassLoaderå†å§”æ‰˜ç»™BootStrapLoaderå¼€å§‹è¿›è¡ŒåŠ è½½ï¼ŒBootStrapLoaderå¦‚æœåŠ è½½ä¸åˆ°å†å§”æ‰˜ç»™ExtClassLoaderï¼ŒExtClassLoaderåŠ è½½ä¸åˆ°å†å§”æ‰˜ç»™AppClassLoaderï¼Œè¿™æ ·ä¸€ä¸ªè‡ªä¸‹è€Œä¸Šå†è€Œä¸‹çš„è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹ï¼Œå†æ¬¡å¯¹ç…§ä¸‹æµç¨‹å›¾ï¼Œä¹Ÿç¬¦åˆ**

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2bf8867072d409cb332dc619b6bf5eb~tplv-k3u1fbpfcp-watermark.image)


## åŒäº²å§”æ´¾æœºåˆ¶æµç¨‹å¸¦æ¥çš„æ€è€ƒ

### æ€è€ƒä¸€

**ä¸ºä»€ä¹ˆç±»çš„åŠ è½½å™¨æ˜¯è‡ªä¸‹è€Œä¸Šè¿›è¡Œå§”æ‰˜ï¼Œè€Œä¸æ˜¯ç”±ä¸Šåˆ°ä¸‹æˆ–è€…å…¶ä»–é¡ºåºå‘¢ï¼Ÿ** å› ä¸ºå¦‚æœç›´æ¥ä»ä¸Šåˆ°ä¸‹å¼€å§‹åŠ è½½åªéœ€è¦èµ°ä¸€éï¼Œå¦‚æœä»ä¸‹åˆ°ä¸Šå†åˆ°ä¸‹ï¼Œå°±é‡å¤äº†ä¸€éï¼Œé‚£ä¹ˆè¿™ä¸€éåˆ°åº•æœ‰æ²¡æœ‰å¿…è¦å‘¢ï¼Ÿ

**å…¶å®è¿™æ ·ä¿è¯äº†æ‰€æœ‰çš„ç±»çš„åŠ è½½æµç¨‹éƒ½ä¿æŒç»Ÿä¸€ï¼Œéƒ½æ˜¯ä»AppClassLoaderç±»åŠ è½½å™¨å¼€å§‹è¿›è¡ŒåŠ è½½**

### æ€è€ƒäºŒ

**é‚£JVMä¸ºä»€ä¹ˆè¦ä»AppClassLoaderå¼€å§‹è¿›è¡ŒåŠ è½½å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›BootStrapLoaderç±»åŠ è½½å™¨ï¼Ÿè¿™æ ·çš„è¯å°±é¿å…äº†ä¸€æ¬¡å‘ä¸Šå§”æ‰˜çš„æµç¨‹äº†å—**

åœ¨æˆ‘ä»¬çš„æ—¥å¸¸åº”ç”¨ä¸­ï¼Œ90%ä»¥ä¸Šçš„ç±»éƒ½æ˜¯åœ¨classPathçš„ç›®å½•ä¸‹ï¼Œè™½ç„¶åœ¨ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™ï¼Œä¼šé‡å¤ä¸€è½®å§”æ‰˜ï¼Œä½†æ˜¯å¦‚æœæœ‰ç¬¬äºŒæ¬¡ã€ç¬¬ä¸‰æ¬¡ã€ç¬¬å››æ¬¡ç­‰ç­‰é‡å¤åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼ˆæ‰‹åŠ¨åŠ è½½çš„åœºæ™¯ï¼‰ï¼ŒAppClassLoaderåˆ¤æ–­å¦‚æœå·²ç»åŠ è½½çš„è¯å°±ä¼šç›´æ¥è¿”å›ï¼Œé¿å…å‘ä¸Šå§”æ‰˜

å¦‚æœä»BootStrapLoaderç±»åŠ è½½å™¨å¼€å§‹åˆ¤æ–­ï¼Œé‚£ä¹ˆæ— è®ºé‡å¤å‡ æ¬¡ï¼Œéƒ½éœ€è¦ç”±ä¸Šå¾€ä¸‹èµ°ä¸€éï¼Œè™½ç„¶ç¬¬ä¸€æ¬¡æ˜¯å¿«äº†ï¼Œä½†æ˜¯ä¹‹åçš„æ¯ä¸€æ¬¡å®é™…ä¸Šéƒ½æ…¢äº†

## åŒäº²å§”æ´¾æœºåˆ¶çš„ä¼˜ç¼ºç‚¹

è¯´å®Œäº†**åŒäº²å§”æ´¾æœºåˆ¶æµç¨‹å¸¦æ¥çš„æ€è€ƒ**ï¼Œé‚£ä¹ˆå°±æ¥çœ‹çœ‹è¿™ä¸ªæœºåˆ¶æœ‰å“ªäº›ä¼˜ç¼ºç‚¹å§

### ä¼˜ç‚¹

1. **æ²™ç®±å®‰å…¨æœºåˆ¶**ï¼š**ä¸åŒçš„ç±»ç”±ä¸åŒçš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œä¿æŠ¤Javaæ ¸å¿ƒçš„ç±»ä¸è¢«éšæ„çš„ä¿®æ”¹**

2. **é¿å…ç±»çš„é‡å¤åŠ è½½**ï¼šå½“çˆ¶åŠ è½½å™¨å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œæ²¡æœ‰å¿…è¦å­ç±»çš„classLoaderå†å»åŠ è½½ä¸€éï¼Œ**ä¿è¯è¢«åŠ è½½çš„ç±»çš„å”¯ä¸€æ€§**


æ²™ç®±å®‰å…¨æœºåˆ¶çš„åœºæ™¯ï¼šåœ¨åº”ç”¨ç¨‹åºä¸‹æ–°å»ºjava.langåŒ…ï¼Œåœ¨åŒ…ä¸‹é¢æ–°å»ºStringç±»ï¼Œåœ¨Stringç±»ä¸­è¿è¡Œmainæ–¹æ³•

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/931601e97f4e43319bc67f4a5a9c88bf~tplv-k3u1fbpfcp-zoom-1.image)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4ab040e94b1475db31dd9ed770a2ab4~tplv-k3u1fbpfcp-zoom-1.image)

åˆ†æè¾“å‡ºç»“æœï¼š

**å› ä¸ºåœ¨åŒäº²å§”æ´¾æœºåˆ¶ä¸­ï¼Œå‘ä¸Šå§”æ‰˜åˆ°BootStrapLoaderç±»åŠ è½½å™¨çš„æ—¶å€™ï¼Œå‘ç°java.lang.Stringåœ¨å®ƒæ‰«æçš„è·¯å¾„ä¸‹ï¼Œæ‰€ä»¥å®ƒä¼šå»åŠ è½½ï¼ˆåªè®¤æ–‡ä»¶åï¼‰ï¼Œä½†æ˜¯å®ƒåŠ è½½çš„ä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„Stringç±»ï¼ŒåŠ è½½çš„æ˜¯rtåŒ…ä¸‹çš„Stringç±»ï¼Œè€Œjavaè‡ªå¸¦çš„Stringç±»æ˜¯æ²¡æœ‰mainæ–¹æ³•çš„ï¼Œè¿™é‡Œå°±ä¼šæŠ¥é”™ï¼Œå¾ˆå¥½çš„ä¿æŠ¤äº†Javaæ ¸å¿ƒçš„ç±»åº“ä¸è¢«éšæ„çš„ä¿®æ”¹**

### ç¼ºç‚¹

**åŒäº²å§”æ´¾è¿™ç§ç±»çš„åŠ è½½æ¨¡å¼ä¹Ÿä¸æ˜¯é€‚ç”¨äºæ‰€æœ‰çš„åœºæ™¯**

ä¸¾ä¸ªä¾‹å­ï¼šåŒäº²å§”æ´¾çš„ä¸€ä¸ªå¾ˆé²œæ˜çš„ç‰¹ç‚¹å°±æ˜¯**ç›¸åŒè·¯å¾„ä¸‹çš„ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡**ï¼Œä½†æ˜¯åœ¨Tomcatä¸­ï¼Œå¦‚æœä¸€ä¸ªTomcatæƒ³éƒ¨ç½²å¤šä¸ªåº”ç”¨ï¼Œè€Œè¿™å¤šä¸ªåº”ç”¨æ°å·§ä¾èµ–äº†ä¸åŒå°ç‰ˆæœ¬ä¹‹é—´çš„Springï¼Œæ¯”å¦‚Spring4.1xã€Spring4.2xï¼Œè¿™ä¸¤ä¸ªå¾®å°ç‰ˆæœ¬çš„Springè‚¯å®šä¼šæœ‰ç›¸åŒè·¯å¾„çš„ç±»ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶çš„ç±»åŠ è½½å™¨ï¼Œè¿™ä¸¤ä¸ªç›¸åŒè·¯å¾„ä¸‹çš„ç±»åªä¼šè¢«åŠ è½½ä¸€ä¸ªï¼Œå…¶ä¸­ä¸€ä¸ªåº”ç”¨æ­£å¥½è¿ç”¨åˆ°äº†å¦å¤–ä¸€ä¸ªç±»çš„æŸäº›ç‰¹æ€§ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå¯¼è‡´åº”ç”¨æ— æ³•æ­£å¸¸æ‰§è¡Œï¼Œæ‰€ä»¥**åŒäº²å§”æ´¾æœºåˆ¶åœ¨Tomcatåœºæ™¯ä¸­è‚¯å®šä¸é€‚ç”¨ï¼Œå°±å¿…é¡»è§„é¿è¿™ç§åŒäº²å§”æ´¾æœºåˆ¶**



## è‡ªå®šä¹‰ç±»åŠ è½½å™¨

æ—¢ç„¶è¦è§„é¿è¿™ç§åŒäº²å§”æ´¾æœºåˆ¶ï¼Œç”¨**ç°æœ‰çš„ç±»åŠ è½½å™¨**è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œæ‰€ä»¥é¦–å…ˆå°±æ˜¯è¦**è‡ªå®šä¹‰ç±»åŠ è½½å™¨**

è‡ªå®šä¹‰åŠ è½½å™¨åªéœ€è¦ç»§æ‰¿java.lang.ClassLoaderç±»ï¼Œè¿™ä¸ªç±»é‡Œé¢æœ‰ä¸¤ä¸ªæ ¸å¿ƒçš„æ–¹æ³•

- ä¸€ä¸ªæ˜¯**loadClassæ–¹æ³•**ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­å®ç°äº†æˆ‘ä»¬çš„**åŒäº²å§”æ´¾æœºåˆ¶**
- è¿˜æœ‰ä¸€ä¸ªæ˜¯**findClassæ–¹æ³•**ï¼Œé»˜è®¤æ˜¯ç©ºå®ç°ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å°±æ˜¯æ ¹æ®è·¯å¾„æ‰¾åˆ°æˆ‘ä»¬çš„ç±»å¹¶è¿›è¡ŒåŠ è½½ï¼Œæ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶åªéœ€è¦**é‡å†™loadClassæ–¹æ³•**å°±å¯ä»¥äº†

### ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨

æˆ‘ä»¬å…ˆåªé‡å†™findClassæ–¹æ³•ï¼Œæ¥è¯´æ˜ä¸ºä»€ä¹ˆä¸€å®šè¦é‡å†™loadClassæ–¹æ³•

```java
public class MyClassLoaderTest {
    // è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬éƒ½éœ€è¦ç»§æ‰¿ä¸€ä¸ªClassLoaderï¼ˆæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥å¤ç”¨ï¼‰
    static class MyClassLoader extends ClassLoader {
        // è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ç±»çš„è·¯å¾„
        private String classpath;
        public MyClassLoader(String classpath) {
            this.classpath = classpath;
        }
        /**
         * è‡ªå®šä¹‰è¯»å–æ–‡ä»¶æ–¹æ³•
         * @param name æ–‡ä»¶è·¯å¾„å
         * @return è¯»å–çš„äºŒè¿›åˆ¶æ•°æ®
         * @throws Exception ä¸€åœº
         */
        private  byte[] loadByte(String name) throws Exception {
            name = name.replaceAll("\\.", "/");
            FileInputStream fileInputStream = new FileInputStream(classpath + "/" + name + ".class");
            int len = fileInputStream.available();
            byte[] data = new byte[len];
            fileInputStream.read(data);
            fileInputStream.close();
            return data;
        }

        @Override
        protected Class<?> findClass(String name) throws ClassNotFoundException {
            try {
                // è‡ªå®šä¹‰ç±»çš„è¯»å–æ–¹æ³•
                byte[] data = loadByte(name);
                // defineClass æ–¹æ³•åªæ˜¯ç±»çš„åŠ è½½ï¼Œç”¨åŸç”Ÿçš„å³å¯
                return defineClass(name, data, 0, data.length);
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClassNotFoundException();
            }
        }
    }
 
    public static void main(String[] args) throws Exception {
        // åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader
        MyClassLoader classLoader = new MyClassLoader("D:/test");
        // Dç›˜åˆ›å»º test/classLoader/TestJDKClassLoader å°†TestJDKClassLoader.classä¸¢å…¥è¯¥ç›®å½•
        Class clazz = classLoader.loadClass("classLoader.TestJDKClassLoader");
        Object obj = clazz.newInstance();
        Method method = clazz.getDeclaredMethod("sout", null);
        method.invoke(obj, null);
        System.out.println(clazz.getClassLoader().getClass().getName());

    }
}
```

æˆ‘ä»¬çœ‹ä¸‹è¾“å‡ºç»“æœï¼š

```
I can fly
sun.misc.Launcher$AppClassLoader
```

æˆ‘ä»¬å‘ç°è™½ç„¶ç¼–å†™äº†è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯TestJDKClassLoaderç±»ä¸ºä»€ä¹ˆæ˜¯è¢«**AppClassLoaderç±»åŠ è½½å™¨åŠ è½½çš„**ï¼Œæˆ‘ä»¬å¸¦ç€è¿™ä¸ªç–‘é—®æ¥ç»§ç»­çœ‹

### è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨

åœ¨ä¸Šç¯‡æ–‡ç« ä¸­æœ‰è¯´é“ï¼šæ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªparentå±æ€§ï¼Œé‚£ä¹ˆ**è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„parentå±æ€§**å­˜å‚¨çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¥çœ‹ä¸‹æºç ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67dbc918fe304364a7366e00f501467c~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘ä»¬å‘ç°åœ¨åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ—¶å€™ï¼Œç”±äºå®ƒ**ç»§æ‰¿ClassLoader**ï¼Œæ‰€ä»¥ä¼šå…ˆå»è°ƒç”¨**çˆ¶ç±»çš„æ„é€ å‡½æ•°**ï¼Œåœ¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œé»˜è®¤çš„å¡äº†ä¸€ä¸ª**ç³»ç»Ÿç±»åŠ è½½å™¨**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bee90f90e4b34944a470387773cf7fa8~tplv-k3u1fbpfcp-zoom-1.image)

è·Ÿåˆ°**getSystemClassLoaderæ–¹æ³•**ä¸­ï¼Œå‘ç°å®ƒè°ƒç”¨çš„è¿˜æ˜¯**Launcher.getClassLoader**ï¼Œè€Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å°±æ˜¯**AppClassLoader**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5012bb9233b04a9398ae21aa5b8a9e41~tplv-k3u1fbpfcp-zoom-1.image)

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„parentå±æ€§å°±æ˜¯ä¸Šé¢çš„AppClassLoaderç±»åŠ è½½å™¨**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06140514b9c548d3bfd96c5dde05dbb0~tplv-k3u1fbpfcp-zoom-1.image)

è¿™ä¸€é¡¿åˆ†æå…¶å®è§£é‡Šäº†ä¸Šé¢çš„é—®é¢˜ï¼š

- è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨é»˜è®¤æƒ…å†µä¸‹çš„**çˆ¶ç±»æ˜¯AppClassLoader**ï¼Œç”±äºæ²¡æœ‰é‡å†™loadClassæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´**æ²¡æœ‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶**ï¼Œæ‰€ä»¥è¿˜æ˜¯æ‰§è¡Œäº†**åŒäº²å§”æ´¾æ¨¡å¼**
- åœ¨é¡¹ç›®ä¸­æ²¡æœ‰æŠŠ`TestJDKClassLoader.java`è¿™ä¸ªç±»ç»™åˆ é™¤æ‰ï¼ŒAppClassLoaderè¿˜æ˜¯èƒ½åœ¨é¡¹ç›®è·¯å¾„ä¸‹è¯»åˆ°**ç¼–è¯‘åçš„TestJDKClassLoader.classæ–‡ä»¶**

é‚£ä¹ˆæˆ‘ä»¬åˆ é™¤é¡¹ç›®é‡Œçš„TestJDKClassLoader.javaç±»ï¼Œå¹¶ä¸”åœ¨æŒ‡å®šçš„ç›®å½•ï¼š**D:/test/classLoaderä¸‹åˆ›å»º**TestJDKClassLoader.classæ–‡ä»¶ï¼Œå†æ¬¡è¾“å‡ºç»“æœï¼Œå‘ç°å°±å˜æˆè‡ªå®šä¹‰ç±»åŠ è½½å™¨

```
I can fly
classLoader.MyClassLoaderTest$MyClassLoader
```

æ³¨æ„ï¼š**è™½ç„¶è¾“å‡ºäº†è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä½†è¿˜æ˜¯èµ°äº†åŒäº²å§”æ´¾æ¨¡å¼ï¼Œåªæ˜¯çˆ¶ç±»AppClassLoaderå†å®ƒçš„è·¯å¾„ä¸‹æ‰¾ä¸åˆ°TestJDKClassLoader.classæ–‡ä»¶è€Œå·²**ï¼Œä¸ºäº†æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å¼ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼š

### æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶

ä¸ºäº†æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè¿˜æ˜¯éœ€è¦é‡å†™loadClassæ–¹æ³•ï¼Œåœ¨loadClassæ–¹æ³•ä¸­ä¸å§”æ‰˜ç»™çˆ¶ç±»å°è¯•ç€è¿›è¡ŒåŠ è½½ï¼Œç›´æ¥åœ¨å½“å‰çš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡å†™ä¸‹loadClass

```java
public class MyClassLoaderTest {

    // è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬éƒ½éœ€è¦ç»§æ‰¿ä¸€ä¸ªClassLoaderï¼ˆæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥å¤ç”¨ï¼‰
    static class MyClassLoader extends ClassLoader {
        private String classpath;
        public MyClassLoader(String classpath) {
            this.classpath = classpath;
        }
        /**
         * è‡ªå®šä¹‰è¯»å–æ–‡ä»¶æ–¹æ³•
         * @param name æ–‡ä»¶è·¯å¾„å
         * @return è¯»å–çš„äºŒè¿›åˆ¶æ•°æ®
         * @throws Exception ä¸€åœº
         */
        private  byte[] loadByte(String name) throws Exception {
            name = name.replaceAll("\\.", "/");
            FileInputStream fileInputStream = new FileInputStream(classpath + "/" + name + ".class");
            int len = fileInputStream.available();
            byte[] data = new byte[len];
            fileInputStream.read(data);
            fileInputStream.close();
            return data;
        }

        @Override
        protected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
            synchronized (getClassLoadingLock(name)) {
                // First, check if the class has already been loaded
                Class<?> c = findLoadedClass(name);
                if (c == null) {
                    // å‘ç°å¦‚æœå½“å‰ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡ï¼Œé‚£ä¹ˆå°±å»åŠ è½½
                    c = findClass(name);
                }
                if (resolve) {
                    resolveClass(c);
                }
                return c;
            }
        }

        @Override
        protected Class<?> findClass(String name) throws ClassNotFoundException {
            try {
                // è‡ªå®šä¹‰ç±»çš„è¯»å–æ–¹æ³•
                byte[] data = loadByte(name);
                // defineClass æ–¹æ³•åªæ˜¯ç±»çš„åŠ è½½ï¼Œç”¨åŸç”Ÿçš„å³å¯
                return defineClass(name, data, 0, data.length);
            } catch (Exception e) {
                e.printStackTrace();
                throw new ClassNotFoundException();
            }
        }
    }
    public static void main(String[] args) throws Exception {
        // åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader
        MyClassLoader classLoader = new MyClassLoader("D:/test");
        // Dç›˜åˆ›å»º test/classLoader/TestJDKClassLoader å°†TestJDKClassLoader.classä¸¢å…¥è¯¥ç›®å½•
        Class clazz = classLoader.loadClass("classLoader.TestJDKClassLoader");
        Object obj = clazz.newInstance();
        Method method = clazz.getDeclaredMethod("sout", null);
        method.setAccessible(true);
        method.invoke(obj, null);
        System.out.println(clazz.getClassLoader().getClass().getName());

    }
}
```

è¿è¡Œåº”ç”¨ç¨‹åºåå‘ç°æŠ¥äº†ä¸‹å›¾ä¸­çš„é”™

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b26052ad0ae24b6f8c33b6fb9667a086~tplv-k3u1fbpfcp-zoom-1.image)

- ä¸€æ–¹é¢ï¼šå› ä¸ºåœ¨javaä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªç±»éƒ½ä¼šç»§æ‰¿**Objectç±»**ï¼Œä½†æ˜¯**Object.class**æ–‡ä»¶æ˜¯ä¸å­˜åœ¨**test/classLoader**ç›®å½•ä¸‹

- å¦ä¸€æ–¹é¢ï¼šJavaä¹Ÿä¸ä¼šå…è®¸æ ¸å¿ƒçš„åŒ…ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½**è¦æ˜¯ä¸ä¿¡å¯ä»¥è‡ªå·±æŠŠObject.classæ‹–å‡ºæ¥æ”¾åˆ°å¯¹åº”ç›®å½•ä¸‹ï¼Œä¼šæŠ¥å®‰å…¨é”™è¯¯ï¼Œè¿™é‡Œå°±ä¸è´´å›¾äº†**

#### è¿‡æ»¤ç‰¹æ®Šçš„ç±»

ä¸ºäº†èƒ½è®©Objectç±»åŠ è½½ï¼Œæˆ‘ä»¬è¿˜å¾—åœ¨loadClassåšä¸€ä¸ªç®€å•çš„è¿‡æ»¤ï¼Œä¿è¯ç‰¹å®šçš„ç±» **(ç±»ä¼¼Object)** è¿˜æ˜¯èµ°åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè‡ªå·±åº”ç”¨ç¨‹åºçš„ç±»å°±æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼š

```
        @Override
        protected Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
            synchronized (getClassLoadingLock(name)) {
                Class<?> c = findLoadedClass(name);
                if (c == null) {
                    // å¦‚æœæ˜¯æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶
                    if (name.startsWith("classLoader")) {
                        c = findClass(name);
                    } else {
                        // å¦åˆ™å°±èµ°åŒäº²å§”æ´¾æœºåˆ¶
                        c = this.getParent().loadClass(name);
                    }
                }
                if (resolve) {
                    resolveClass(c);
                }
                return c;
            }
        }
```

æˆ‘ä»¬è¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼š

```
I can fly
classLoader.MyClassLoaderTest$MyClassLoader
```

å¯ä»¥çœ‹åˆ°å³ä½¿åœ¨é¡¹ç›®ä¸­å­˜åœ¨äº†classLoader.MyClassLoaderTestç±»ï¼Œè¿˜æ˜¯ä½¿ç”¨äº†è‡ªå·±çš„ç±»åŠ è½½å™¨åŠ è½½ï¼Œæ²¡ç”¨çˆ¶ç±»çš„AppClassLoaderç±»åŠ è½½å™¨ï¼Œè¯æ˜å·²ç»æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶


### æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„åœºæ™¯

æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„åœºæ™¯æœ‰ä¸å°‘ï¼Œå…¸å‹çš„å°±æ˜¯Tomcat

 1. ä¸€ä¸ªTomcatå¯èƒ½éƒ¨ç½²å¤šä¸ªåº”ç”¨ï¼Œä¸åŒçš„åº”ç”¨å¯èƒ½ä¾èµ–çš„åŒä¸€ä¸ªç¬¬ä¸‰æ–¹ç±»åº“çš„ä¸åŒç‰ˆæœ¬ï¼ˆä¼šé€ æˆå¾ˆå¤šå¤§é‡çš„æ–‡ä»¶è·¯å¾„ç›¸åŒçš„ç±»ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¸èƒ½é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å»åŠ è½½ï¼Œè¦ä¿è¯æ¯ä¸ªåº”ç”¨çš„ç±»åº“æ˜¯ç‹¬ç«‹çš„ï¼Œç›¸äº’éš”ç¦»

 2. webå®¹å™¨è¦æ”¯æŒjspä¿®æ”¹ï¼Œjspæ–‡ä»¶æœ€ç»ˆä¹Ÿéœ€è¦ç¼–è¯‘æˆclassæ–‡ä»¶æ‰èƒ½åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œä½†ç¨‹åºè¿è¡Œåä¿®æ”¹jspæ˜¯ä¸€ä»¶é«˜é¢‘çš„äº‹æƒ…ï¼Œwebå®¹å™¨éœ€è¦æ”¯æŒjspä¿®æ”¹åæ— éœ€é‡å¯

 3. ......**è¿˜æœ‰å¾ˆå¤šåœºæ™¯ï¼Œéœ€è¦å¤§å®¶è‡ªå·±äº†è§£**

# æœ¬æ–‡æ€»ç»“

å¥½å•¦ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œå¤§è‡´ä¸Šå¯ä»¥åˆ’åˆ†æˆä»¥ä¸‹å‡ å—å†…å®¹

1. ç»“åˆæºç æ¥åˆ†æ**åŒäº²å§”æ´¾æœºåˆ¶æµç¨‹**
2. è¯´è¯´**åŒäº²å§”æ´¾æœºåˆ¶å¸¦æ¥çš„æ€è€ƒ**ï¼Œä»¥åŠå®ƒçš„ä¼˜ç¼ºç‚¹
3. å¦‚ä½•**è‡ªå®šä¹‰ç±»åŠ è½½å™¨**ï¼Œéœ€è¦æ³¨æ„å“ªäº›ç‚¹
4. **å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶**

çœ‹åˆ°è¿™ï¼Œæˆ‘ç›¸ä¿¡å„ä½çœ‹å®˜éƒ½èƒ½å›ç­”ç¯‡å¤´çš„ä¸¤ä¸ªé—®é¢˜ï¼š

- **ä¸ºä»€ä¹ˆä¸åŒçš„ç±»åŠ è½½å™¨çš„è¯»å–ç±»è·¯å¾„ä¸åŒï¼Ÿè®©ä¸åŒçš„ç±»ç”±ä¸åŒçš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¯ä»¥ä¿æŠ¤Javaæ ¸å¿ƒçš„ç±»ä¸è¢«éšæ„çš„ä¿®æ”¹**

- æ¯ä¸ªç±»åŠ è½½å™¨çš„parentå±æ€§åˆ°åº•æœ‰ä»€ä¹ˆï¼Œ**ä¸ºä»€ä¹ˆè¦è®¾ç«‹è¿™ç§çˆ¶å­å…³ç³»ï¼Ÿè®¾ç«‹çˆ¶å­å…³ç³»çš„ç›®çš„è¿˜æ˜¯å®ç°åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå…·ä½“å¯ä»¥çœ‹å®ƒçš„ä¼˜ç‚¹**


å…³äºç±»åŠ è½½ä¹Ÿå°±å‘Šä¸€æ®µè½äº†ï¼Œä½†æ˜¯è¿™ä¸æ˜¯ç±»åŠ è½½çš„**ç»ˆç‚¹**ï¼Œåé¢ä¼šå‡º**Tomcatç³»åˆ—çš„æ–‡ç« **ï¼Œå…¶ä¸­æœ‰ä¸€å—å°±æ˜¯**è‡ªå®šä¹‰ç±»åŠ è½½å™¨åœ¨Tomcatä¸­çš„åº”ç”¨**ï¼Œè¿™é‡Œå°±ä¸é€‚åˆè¯¦ç»†å±•å¼€ï¼Œå°ä¼™ä¼´å¯ä»¥æœŸå¾…ä¸€ä¸‹

ç±»åŠ è½½çš„ç›®çš„æ˜¯æŠŠ**ç±»çš„å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVMè¿è¡Œæ—¶æ•°æ®åŒºå˜æˆå¯ä»¥ç›´æ¥ç”¨çš„ç±»å…ƒä¿¡æ¯**ï¼Œä½†æ˜¯JVMè¿è¡Œæ—¶æ•°æ®åŒºå­˜çš„ä¸ä»…ä»…æ˜¯**ç±»å…ƒä¿¡æ¯**å¯¹å—ï¼Ÿæ‰€ä»¥ä¸‹ç¯‡æ–‡ç« å°±æ¥åˆ†æä¸€ä¸ªå¯¹è±¡æ˜¯æ€ä¹ˆè¿›å…¥åˆ°JVMè¿è¡Œæ—¶æ•°æ®åŒºï¼Œåˆ°åº•å­˜åœ¨äº†å“ªé‡Œï¼Ÿ

# çµ®å¨

æœ€åï¼Œå¦‚æœæ„Ÿåˆ°æ–‡ç« æœ‰å“ªé‡Œå›°æƒ‘çš„ï¼Œè¯·ç¬¬ä¸€æ—¶é—´ç•™ä¸‹è¯„è®ºï¼Œå¦‚æœå„ä½çœ‹å®˜è§‰å¾—æˆ‘æœ‰ç‚¹ä¸œè¥¿çš„è¯ æ±‚ç‚¹èµğŸ‘ æ±‚å…³æ³¨â¤ï¸ æ±‚åˆ†äº«ğŸ‘¥ å¯¹æˆ‘æ¥è¯´çœŸçš„éå¸¸æœ‰ç”¨ï¼ï¼ï¼å¦‚æœæƒ³è·å–**ç”µå­ä¹¦ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼šJVMé«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µï¼ˆç¬¬3ç‰ˆï¼‰å‘¨å¿—æ˜ã€‹**ï¼Œå¯ä»¥å…³æ³¨å¾®ä¿¡å…¬ä¼—å·**Javaç™¾ç§‘å…¨ä¹¦**ï¼Œæœ€åçš„æœ€åï¼Œæ„Ÿè°¢å„ä½çœ‹å®˜çš„æ”¯æŒï¼ï¼ï¼